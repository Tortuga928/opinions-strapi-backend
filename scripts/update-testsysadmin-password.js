const Database = require('better-sqlite3');
const path = require('path');

// Path to SQLite database
const dbPath = path.join(__dirname, '..', '.tmp', 'data.db');

// New password hash (generated by reset-testsysadmin.js)
const newPasswordHash = '$2a$10$OXIftOL4jyz.rQEa0IZpXu9rNOKAP2BO.HH/cqELIF4wOLCwjnJgG';

try {
  // Open database connection
  const db = new Database(dbPath);

  console.log('Connected to database:', dbPath);

  // First, check if user exists
  const user = db.prepare('SELECT * FROM up_users WHERE username = ?').get('testsysadmin');

  if (!user) {
    console.error('‚ùå User testsysadmin not found in database!');
    process.exit(1);
  }

  console.log('\nüìã Current user details:');
  console.log('  ID:', user.id);
  console.log('  Username:', user.username);
  console.log('  Email:', user.email);
  console.log('  Confirmed:', user.confirmed);
  console.log('  Blocked:', user.blocked);
  console.log('  Current password hash:', user.password.substring(0, 30) + '...');

  // Update password
  const updateStmt = db.prepare('UPDATE up_users SET password = ? WHERE username = ?');
  const result = updateStmt.run(newPasswordHash, 'testsysadmin');

  if (result.changes > 0) {
    console.log('\n‚úÖ Password updated successfully!');
    console.log('   Changes:', result.changes);
    console.log('   New password: TestAdmin123!');

    // Verify update
    const updatedUser = db.prepare('SELECT password FROM up_users WHERE username = ?').get('testsysadmin');
    console.log('   New hash:', updatedUser.password.substring(0, 30) + '...');
  } else {
    console.error('‚ùå Failed to update password - no rows affected');
  }

  db.close();
  console.log('\n‚úÖ Database connection closed');

} catch (error) {
  console.error('‚ùå Error updating password:', error.message);
  process.exit(1);
}
